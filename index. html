<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Client-side Wallet — Generate / Balance / Send / Swap</title>
<style>
body{font-family:Inter,Arial,Helvetica,sans-serif;background:#0f1724;color:#e6eef8;padding:18px}
.card{background:#071022;border-radius:12px;padding:18px;max-width:980px;margin:18px auto;box-shadow:0 8px 28px rgba(2,6,23,.6)}
h1{font-size:20px;margin:0 0 10px}
label{display:block;margin-top:10px;font-size:13px;color:#9fb0c7}
input,select,button,textarea{font-size:14px}
input[type=text],input[type=password],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #163044;background:#06101a;color:#dfeeff}
.row{display:flex;gap:8px}
.col{flex:1}
button{padding:10px 12px;border-radius:8px;border:none;cursor:pointer}
.primary{background:#0b84ff;color:white}
.muted{background:#122532;color:#9fb0c7}
pre{background:#061425;padding:12px;border-radius:8px;white-space:pre-wrap}
.small{font-size:12px;color:#89a6c3}
.flex-between{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div class="card">
<div class="flex-between">
<h1>محفظة Client-side — Generate · Balance · Send · Swap</h1>
<div class="small">Client-side only — المفاتيح لا تخرج من المتصفح</div>
</div>

<label>اختر شبكة (Network)</label>
<select id="network">
<option value="eth">Ethereum (Mainnet)</option>
<option value="base">Base</option>
</select>

<div style="margin-top:12px" class="row">
<button id="gen" class="primary col">إنشاء محفظة جديدة</button>
<button id="importMnemonic" class="muted col">استيراد من 12 كلمة (Mnemonic)</button>
<button id="importPK" class="muted col">استيراد من Private Key</button>
</div>

<label>العنوان (Address)</label>
<input id="address" type="text" readonly />

<label>الـ 12 كلمة (Mnemonic)</label>
<pre id="mnemonic">—</pre>

<label>المفتاح الخاص (Private Key)</label>
<pre id="pk">—</pre>

<div style="margin-top:12px" class="row">
<button id="showBalance" class="primary col">تحديث الرصيد</button>
<button id="downloadKeystore" class="muted col">تحميل Keystore مشفر</button>
</div>

<label>الرصيد (ETH)</label>
<input id="balance" type="text" readonly />

<hr style="margin:14px 0;border-color:#0f2433" />

<h3>إرسال (Send)</h3>
<label>إلى (To address)</label>
<input id="to" type="text" placeholder="0x..." />
<label>المبلغ (ETH)</label>
<input id="amount" type="text" placeholder="0.01" />
<div style="margin-top:8px" class="row">
<button id="sendTx" class="primary col">إرسال</button>
<button id="estimateGas" class="muted col">تقدير الغاز</button>
</div>
<label>نتيجة الإرسال / الحالة</label>
<pre id="txStatus">—</pre>

<hr style="margin:14px 0;border-color:#0f2433" />

<h3>Swap (يعمل عبر 0x API — Client-side)</h3>
<label>Sell (from)</label>
<input id="sellToken" type="text" placeholder="ETH أو contract address (مثال: 0x6B...)" />
<label>Buy (to)</label>
<input id="buyToken" type="text" placeholder="USDT أو contract address" />
<label>Amount (sell amount) — لو ETH اكتب رقم (مثال: 0.1)</label>
<input id="sellAmount" type="text" placeholder="0.1" />
<div style="margin-top:8px" class="row">
<button id="getQuote" class="muted col">اجلب Quote</button>
<button id="doSwap" class="primary col">نفّذ Swap</button>
</div>

<label>Quote / معلومات السواب</label>
<pre id="quoteResult">—</pre>

<hr style="margin:14px 0;border-color:#0f2433" />

<h4>نقاط أمان</h4>
<ul class="small">
<li>هذا التطبيق يولّد ويوقع المعاملات <strong>محليًا</strong> على جهاز المستخدم.</li>
<li>لا تخزن المفاتيح على سيرفر؛ لو فعلت ذلك ستكون مسؤولًا عن أمان المستخدمين.</li>
<li>لا تشارك الـ mnemonic أو private key مع أي أحد.</li>
</ul>

</div>

<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
<script>
// RPCs for supported networks
const RPCS = {
  eth: { rpc: 'https://rpc.ankr.com/eth', apiBase: 'https://api.0x.org' },
  base: { rpc: 'https://rpc.base.org', apiBase: 'https://api.0x.org' }
};

let currentWallet = null;
let provider = null;

const $ = id => document.getElementById(id);

function setNetwork() {
  const net = $('network').value;
  provider = new ethers.providers.JsonRpcProvider(RPCS[net].rpc);
}

setNetwork();
$('network').addEventListener('change', ()=>{ setNetwork(); $('balance').value=''; });

function loadWallet(wallet){
  currentWallet = wallet.connect(provider);
  window.__currentWallet = currentWallet;
  $('address').value = wallet.address;
  $('mnemonic').textContent = wallet.mnemonic ? wallet.mnemonic.phrase : '—';
  $('pk').textContent = wallet.privateKey;
  $('balance').value='';
}

// Generate wallet
$('gen').addEventListener('click', ()=>{ loadWallet(ethers.Wallet.createRandom()); });

// Import wallet
$('importMnemonic').addEventListener('click', ()=>{
  const m = prompt('ادخل الـ 12 كلمة (Mnemonic)');
  if(!m) return;
  try{ loadWallet(ethers.Wallet.fromMnemonic(m.trim())); }catch(e){alert('خطأ في الـ mnemonic');}
});
$('importPK').addEventListener('click', ()=>{
  const k = prompt('ادخل الـ private key');
  if(!k) return;
  try{ loadWallet(new ethers.Wallet(k.trim())); }catch(e){alert('خطأ في المفتاح');}
});

// Download keystore
$('downloadKeystore').addEventListener('click', async ()=>{
  if(!window.__currentWallet){alert('انشئ محفظة أولاً'); return;}
  const password = prompt('ادخل كلمة مرور لتشفير keystore');
  if(!password) return;
  try{
    const json = await window.__currentWallet.encrypt(password);
    const blob = new Blob([json],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='keystore.json'; a.click();
  }catch(e){alert('فشل التشفير')}
});

// Show balance
$('showBalance').addEventListener('click', async ()=>{
  if(!window.__currentWallet){alert('انشئ محفظة أولاً'); return;}
  const bal = await provider.getBalance(window.__currentWallet.address);
  $('balance').value = ethers.utils.formatEther(bal)+' ETH';
});

// Estimate gas
$('estimateGas').addEventListener('click', async ()=>{
  if(!window.__currentWallet){alert('انشئ محفظة أولاً'); return;}
  const to=$('to').value.trim(); const amount=$('amount').value.trim();
  if(!ethers.utils.isAddress(to)){alert('عنوان غير صالح'); return;}
  if(!amount || isNaN(Number(amount))){alert('مبلغ غير صالح'); return;}
  const tx = {to,value:ethers.utils.parseEther(amount)};
  try{const g = await provider.estimateGas(tx); alert('تقدير الغاز: '+g.toString());}catch(e){alert('فشل تقدير الغاز')}
});

// Send ETH
$('sendTx').addEventListener('click', async ()=>{
  if(!window.__currentWallet){alert('انشئ محفظة أولاً'); return;}
  const to=$('to').value.trim(); const amount=$('amount').value.trim();
  if(!ethers.utils.isAddress(to)){alert('عنوان غير صالح'); return;}
  if(!amount || isNaN(Number(amount))){alert('مبلغ غير صالح'); return;}
  try{
    const txReq={to,value:ethers.utils.parseEther(amount)};
    const sent = await window.__currentWallet.sendTransaction(txReq);
    $('txStatus').textContent='تم الإرسال — hash: '+sent.hash+'\nانتظر التأكيد...';
    await sent.wait();
    $('txStatus').textContent='تم التأكيد — hash: '+sent.hash;
  }catch(e){$('txStatus').textContent='خطأ: '+e.message;}
});

// Swap via 0x API
$('getQuote').addEventListener('click', async ()=>{
  if(!window.__currentWallet){alert('انشئ محفظة أولاً'); return;}
  const sellToken=$('sellToken').value.trim()||'ETH';
  const buyToken=$('buyToken').value.trim()||'USDT';
  const sellAmount=$('sellAmount').value.trim();
  if(!sellAmount || isNaN(Number(sellAmount))){alert('مبلغ غير صالح'); return;}
  const net=$('network').value; const apiBase=RPCS[net].apiBase;
  try{
    const url=`${apiBase}/swap/v1/quote?sellToken=${encodeURIComponent(sellToken)}&buyToken=${encodeURIComponent(buyToken)}&sellAmount=${ethers.utils.parseEther(sellAmount).toString()}`;
    const res=await fetch(url); const j=await res.json();
    $('quoteResult').textContent=JSON.stringify(j,null,2); window.__lastQuote=j;
  }catch(e){$('quoteResult').textContent='خطأ في Quote: '+e.message;}
});

// Execute swap
$('doSwap').addEventListener('click', async ()=>{
  if(!window.__currentWallet){alert('انشئ محفظة أولاً'); return;}
  const quote=window.__lastQuote; if(!quote){alert('اجلب Quote أولاً'); return;}
  try{
    const tx={to:quote.to,data:quote.data,value:quote.value?ethers.BigNumber.from(quote.value):undefined,gasLimit:quote.gas?ethers.BigNumber.from(quote.gas):undefined};
    const sent=await window.__currentWallet.sendTransaction(tx);
    $('quoteResult').textContent='Swap sent — hash: '+sent.hash+'\nانتظر التأكيد...';
    await sent.wait();
    $('quoteResult').textContent='Swap confirmed — hash: '+sent.hash;
  }catch(e){$('quoteResult').textContent='فشل تنفيذ Swap: '+e.message;}
});
</script>
</body>
</html>
